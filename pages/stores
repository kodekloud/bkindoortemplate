<style>
    @media (max-width: 767px) {
        .hgroup .breadcrumb {
            bottom:-15px !important;
        }
    }
</style>
<div id="back-top"><img alt="BackToTop" src="http://kodekloud.s3.amazonaws.com/sites/54b83f086e6f646b45000000/c0a5afb0d05049981f657ccf2e67d904/totop.jpg"/></div>
<div id="loading_screen">
    <img src="http://kodekloud.s3.amazonaws.com/sites/5447ebb66e6f641987020000/3604f5c26997bea3de504de139debcec/loading.gif"/>
</div>
<div  id="main_content" style="display:none">
    <ul class="breadcrumb">
        <li><a href="/home">Home</a> </li>
        <li class="active">Store Directory</li>
    </ul>
    <div class="page_banner">
        store directory
    </div>
    <div class="inside_page_content">
        <div class="left_column">
            <img class="inside_banner_image" alt="store list banner" src="http://kodekloud.s3.amazonaws.com/sites/54cfab316e6f6433ad020000/23ec067017848a36dcdff8e19a7cef09/events_aboutus.jpg"/>
            <div class="directory_div" id="no_cat_list">
                <span><p class="directory_header_name directory_name_col">Merchant Name</p><p class="directory_header_phone directory_phone_col">Phone</p></span>
                <div class="store_list" id="store_list_container">
                    <script id="store_list_template" type="x-tmpl-mustache/text">
                        <span><a href="/stores/{{slug}}"><p class="directory_content directory_name_col">{{name}}</p></a><a href="tel:{{phone}}"><p class="directory_content directory_phone_col">{{phone}}</p></a></span>
                    </script>
                </div>
                
            </div>
            <div class="directory_div" id="store_category_list_container">
                <script id="category_store_list_template" type="x-tmpl-mustache/text">
                    <div id="cat{{id}}" class="cat_list_div" style="display:none">
                        <span><p class="directory_header_name directory_name_col">{{name}}</p><p class="directory_header_phone directory_phone_col">Phone</p></span>
                        <div class="store_list" id="cat{{id}}_list"></div>
                    </div>
                </script>    
            </div>
        </div>
        <div class="right_column">
            <a href="/map"><p class="right_column_header">centre map</p></a>
            <br>
            <p class="right_column_header">categories</p>
            <div id="categories_container">
                <a href="#categories_container" onclick="(show_cat('view_all', 'all'))" id="view_all_link" class="cat_links directory_content" style="font-weight:bold">View All</a><br>
            </div>
            <br>
            <p class="right_column_header">centre map</p>
            <div id="centre_info_container">
                <script id="centre_info_template" type="x-tmpl-mustache/text">
                    <p class="cat_links">{{name}}</p>
                    <p class="cat_links">{{address1}}</p>
                    <p class="cat_links">{{city}}, {{province_state}} {{postal_code}}</p>
                </script>
            </div>
            
            
        </div>
    </div>
</div>
<div style="display:none">
<div class="full_page_photo" style="overflow:hidden">

        <div style="overflow:hidden">
            <div id="zControls">
                <button class="zoom-in"><span class="glyphicon glyphicon-plus"></span></button>
                <button class="zoom-out"><span class="glyphicon glyphicon-minus"></span></button>
                
            </div>
            <div id="map" class="panzoom-elements" style=""><img src="http://kodekloud.s3.amazonaws.com/sites/54cfab316e6f6433ad020000/8ac9317674f1fc6bcca268b1915e5589/map_2.png"></div>
        </div>
</div>
<!--For more information please see http://learnjs.io/blog/2013/11/30/snapsvg-resources/-->
<script src="//cdnjs.cloudflare.com/ajax/libs/snap.svg/0.3.0/snap.svg-min.js"></script>
<script src="http://kodekloud.s3.amazonaws.com/sites/5422419e4a616d74d9030000/e1fb5e17ab727d248230fbcb51da868f/jquery.panzoom.min.js"></script>
<script>
    $(document).ready(function() {
        function renderAll (){
            var stores = getStoresList();
            var category_stores = getStoresListByCategory();
            var categories = getStoreCategories();
            var propertyDetails = getPropertyDetails();
            renderPageData('#centre_info_container','#centre_info_template',propertyDetails, 'property_details')
            renderPageData('#store_list_container','#store_list_template', stores, "stores");
            // renderPageData('#categories_container', '#categories_list_template', categories, "categories");
            render_categories(categories);
            render_category_stores();  
            
            $("#loading_screen").hide();
            $("#main_content").show();
            renderSVGMap();
        }
        
    
        function render_categories(categories){
            
            $.each( categories , function( key, val ) {
                val.link = "cat" + val.id;
                $("#categories_container").append('<a href="#categories_container" class="cat_links" onclick=(show_cat('+val.link+')) class="categories" id="cat'+val.id+'_link">'+val.name+'</a><br>');
            });
        };
        function renderPageData(container, template, collection, type){
            var item_list = [];
            var item_rendered = [];
            var template_html = $(template).html();
            Mustache.parse(template_html);   // optional, speeds up future uses
            if (type == "property_details"){
                item_list.push(collection);
                collection = []
                collection = item_list;
            }
            $.each( collection , function( key, val ) {
                if (type == "stores" || type == "category_stores"){
                    if(!val.store_front_url ||  val.store_front_url.indexOf('missing.png') > -1 || val.store_front_url.length === 0){
                            val.alt_store_front_url = "http://kodekloud.s3.amazonaws.com/sites/54cfab316e6f6433ad020000/77c900d783abeb362232339ece231335/10dundas_default.jpg"    
                        } else {
                            val.alt_store_front_url = getImageURL(val.store_front_url);    
                        }
                    switch(val.z_coordinate) {
                        case 0: 
                            val.z_coordinate = "B2"
                            break;
                        case 1:
                            val.z_coordinate = "B1"
                            break;
                        case 2:
                            val.z_coordinate = "Level 1"
                            break;
                        case 3:
                            val.z_coordinate = "Level 2"
                            break;
                        case 4:
                            val.z_coordinate = "Level 3"
                            break;
                        case 5:
                            val.z_coordinate = "Level 4"
                            break;
                        case 6:
                            val.z_coordinate = "Level 5"
                            break;
                        }   
                }
                
                var rendered = Mustache.render(template_html,val);
                item_rendered.push(rendered);
    
            });
            
            $(container).show();
            $(container).html(item_rendered.join(''));
        };
    

        function render_category_stores(){
            
            var category_stores = [];
            var item_rendered = [];
            var all_stores = getStoresList();
            var all_categories = getStoreCategories();
            var test = []
            var template_html = $("#category_store_list_template").html();
            Mustache.parse(template_html);
            for (i = 0; i < all_categories.length; i++) {
                var stores_per_cat = [];
                for (j = 0; j < all_stores.length; j++) {
                    if($.inArray(parseInt(all_categories[i].id), all_stores[j].categories) > -1){
                        all_stores[j].cat_name = all_categories[i].name;
                        category_stores.push(all_stores[j]);
                        stores_per_cat.push(all_stores[j]);
                    }
                
                }
                var rendered = Mustache.render(template_html,all_categories[i]);
                item_rendered.push(rendered);
            }
            $("#store_category_list_container").show();
            $("#store_category_list_container").html(item_rendered.join(''));
            for (i = 0; i < all_categories.length; i++) {
                var stores_per_cat = [];
                for (j = 0; j < all_stores.length; j++) {
                    if($.inArray(parseInt(all_categories[i].id), all_stores[j].categories) > -1){
                        all_stores[j].cat_name = all_categories[i].name;
                        all_stores[j].alt_store_front_url = getImageURL(all_stores[j].store_front_url);    
                        populate_stores_for_cat(all_categories[i].id, all_stores[j]);
                    }
                
                }
            }
            
        };
    
        function populate_stores_for_cat (categoryid, store){
            $('#cat'+categoryid+'_list').append('<span id="store_for_'+store.id+'"><a href="../stores/'+store.slug+'"><p class="directory_content directory_name_col">'+store.name+'</p></a><a href="tel:'+store.phone+'"><p class="directory_content directory_phone_col">  '+store.phone+'</p></a></span>');
            
        }
        
         
    
    function renderSVGMap(){
        var isMobile = ( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) );
        var didPanZoom = false;
        if(navigator.appVersion.indexOf("MSIE 9.") == -1){
            $('#map').bind('mousemove', function(e){
                //console.log(e.pageX+","+e.pageY);
               $('#pop-over').css({'top':e.pageY+20,'left':e.pageX-70});
            });
            var s = Snap("#map");
            var stores = getStoresList();
            // console.log (getSVGMapURL())
            // Snap.load(getSVGMapURL(), function (f) {
            //     $.each( stores, function( key, value ) {
            //         if(value.svgmap_region != null && typeof(value.svgmap_region)  != 'undefined'){
            //             var svg_id = "#" + value.svgmap_region;
            //             f.select(svg_id).mouseover(function() {
            //                 if(typeof(value) != 'undefined' && value != null){
            //                     this.addClass("map-mouse-over");
            //                     $("#pop-over").show();
            //                     $("#pop-over-map-name").html(value.name);
            //                     $("#pop-over-map-phone").html(value.phone);
            //                 }
                                      
            //             });
                            
            //             //add the mouse up handler for hiding the pop over when done hovering
            //             f.select(svg_id).mouseout(function() {
            //                 this.removeClass("map-mouse-over");
            //                 $("#pop-over").hide(0);
                            
            //             });
                            
            //             //add the mouse up function for when the user clicks a store
            //             f.select(svg_id).mouseup(function() {
                            
            //                 if(!isMobile && !didPanZoom){
                                
            //                     goToStore(value);
            //                 }
            //                 didPanZoom = false;
                                  
            //             });
            //         }
            //     });
            //     s.append(f.select("svg"));
            // });
            var startingMapTransform = 'scale(0.50)';
            var startingPanX = -180;
            var startingPanY = -150;
            if(isMobile) {
                    startingMapTransform = 'scale(0.23)';
                    startingPanX = -230;
                    startingPanY = -150;
            }
                // $('#loading').hide();
                $( "#page_content" ).fadeIn( "fast", function() {
                    var panzoom = $(".panzoom-elements").panzoom({
                        cursor: "move",
                        increment: 0.05,
                        minScale: 0.15,
                        maxScale: 20,
                        transition: true,
                        duration: 150,
                        easing: "ease-in-out",
                        $zoomIn: $('.zoom-in'),
                        $zoomOut: $('.zoom-out'),
                        $zoomRange: $('.zoom-range'),
                        startTransform: startingMapTransform
            
                    });
                    $(".panzoom-elements").panzoom("pan", startingPanX, startingPanY, { relative: true });
                    
                    panzoom.on('panzoomchange', function(e, panzoom, matrix, changed) {
                      didPanZoom = true;
                    });
                    
                    panzoom.on('panzoomend', function(e, panzoom, matrix, changed) {
                      didPanZoom = false;
                    });
                });
            }else{
                $('#loading').hide();
                $('#zControls').hide();
                $('#map').hide();
                $( "#page_content" ).fadeIn( "fast");
            }
        }
    
    function goToStore(store_details){
        if(typeof(store_details) != 'undefined' && store_details != null){
            window.location.href = "/stores/"+store_details.slug;
        }
    }

    function getSVGMapURL(){
        initData();
        var mallDataJSON = JSON.parse(sessionStorage.mallData);
        return 'http://cdn.mallmaverick.com' + mallDataJSON.property.svgmap_url;
    }
    
    
        loadMallData(renderAll);  

    
  
    });
    
    function show_cat(link, type){
        $(".cat_links").css("font-weight","normal");
        
        if (type == "all"){
            $("#view_all_link").css("font-weight","bold");
            $("#no_cat_list").show();
            $(".cat_list_div").hide();    
        } else {
            $("#"+link.id+"_link").css("font-weight","bold");
            $("#no_cat_list").hide();
            $(".cat_list_div").hide();
            $("#"+link.id).show();    
        }
    
        
    }
    
    
   
    // hide #back-top first
	$("#back-top").hide();
	
	// fade in #back-top
	$(function () {
		$(window).scroll(function () {
		    if ($(this).scrollTop() > 300) {
    			$('#back-top').fadeIn();
			} else {
				$('#back-top').fadeOut();
			}
		});

		// scroll body to 0px on click
		$('#back-top img').click(function () {
			$('body,html').animate({
				scrollTop: 0
			}, 800);
			return false;
		});
	});
</script>